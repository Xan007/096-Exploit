local TableUtil = loadstring(game:HttpGet(('https://raw.githubusercontent.com/Xan007/096-Exploit/master/utils/TableUtil.lua'), true))()

local Trove = loadstring(game:HttpGet(('https://raw.githubusercontent.com/Xan007/096-Exploit/master/utils/Trove.lua'), true))()

local LocalPlayer = game:GetService("Players").LocalPlayer
local HttpService = game:GetService("HttpService")


local BackpackRemote = game:GetService("ReplicatedStorage").Remotes.Backpack
local ObjectInteractRemote = game:GetService("ReplicatedStorage").Remotes.ObjectInteract
local ToolActionRemote = game:GetService("ReplicatedStorage").Remotes.ToolAction
local CraftRemote = game:GetService("ReplicatedStorage").Remotes.Craft

local PickupRemote = game:GetService("ReplicatedStorage").Remotes.Pickup
local DropRemote = game:GetService("ReplicatedStorage").Remotes.Drop

local GetDataRemote = game:GetService("ReplicatedStorage").Remotes.GetData
local GetMaterialsRemote = game:GetService("ReplicatedStorage").Remotes.GetMaterials

local PlayerData = nil
local PlayerMaterials = nil

local Functions = {}

function Functions.GetPlayerMaterials()
    return PlayerMaterials
end

function Functions.UpdatePlayerMaterials()
    local InvokeReturn = GetMaterialsRemote:InvokeServer()

    if (InvokeReturn) then
        PlayerMaterials = InvokeReturn
    end

    return InvokeReturn
end

function Functions.GetPlayerData()
    return PlayerData
end

function Functions.UpdatePlayerData()
    local InvokeReturn = GetDataRemote:InvokeServer()

    if (InvokeReturn) then
        PlayerData = InvokeReturn
    end

    return InvokeReturn
end

function Functions.GetBackpackItems(backpack)
    backpack = backpack or PlayerData.Backpack

    local items = TableUtil.Filter(backpack, function(value, key)
        return value[1] ~= "None"
    end)

    return items
end

function Functions.GetItemAmount(name)
    local amount = 0

    for _, itemTable in ipairs(Functions.GetBackpackItems()) do
        if (name ~= "Any" and itemTable[1] ~= name) then
            continue
        end
        
        amount = amount + itemTable[2]
    end

    return amount
end

function Functions.DropItem(name)
    local SavedAmount = Functions.GetItemAmount(name)

    if (SavedAmount == 0) then
        return false
    end

    local args = {
        [1] = "Drop",
        [2] = name
    }  

    repeat
        BackpackRemote:FireServer(unpack(args))
        Functions.UpdatePlayerData()
    until SavedAmount > Functions.GetItemAmount(name)

    return true
end

function Functions.SaveItem(pathToItem)
    if (pathToItem == nil or pathToItem.Parent == nil) then
        return false
    end

    local ItemsAmount = Functions.GetItemAmount("Any")
    local NewItemAmount = 0

    if (pathToItem:GetAttribute("Type") == "Food") then
        NewItemAmount = 1
    elseif (pathToItem:GetAttribute("Type") == "Tool") then
        NewItemAmount = 4
    else
        return false
    end
    
    local SavedItems = Functions.GetBackpackItems()
    
    if (ItemsAmount + NewItemAmount) > 30 then
        return false
    end

    if (#SavedItems >= 6) then
        local result = TableUtil.Some(SavedItems, function(value)
            return value[1] == pathToItem.Name and NewItemAmount == 1
        end)

        if result == false then
            return false
        end
    end

    local args = {
        [1] = pathToItem
    }

    local newPos = pathToItem:GetPivot().Position

    repeat
        Functions.Teleport(CFrame.new(newPos))
        ObjectInteractRemote:FireServer(unpack(args))
        
        Functions.UpdatePlayerData()
    until #Functions.GetBackpackItems() > #SavedItems or pathToItem == nil or pathToItem.Parent == nil

    return true
end


function Functions.Pickup(pathToObject)
    if (pathToObject == nil) then
        return false
    end

    if (pathToObject:GetAttribute("Owner") ~= nil and pathToObject:GetAttribute("Owner") ~= LocalPlayer.UserId) then
        return false
    end

    local args = {
        [1] = pathToObject
    }

    local newPos = pathToObject:GetPivot().Position
    
    repeat
        Functions.Teleport(CFrame.new(newPos))   
        PickupRemote:FireServer(unpack(args))
        wait()
    until pathToObject:GetAttribute("PickedUp") == true
end

function Functions.PlaceDrop(position, orientation, sticky)
    local args = {
        [1] = position,
        [2] = orientation,
        [3] = sticky
    }
    
    return DropRemote:InvokeServer(unpack(args))
end

function Functions.Equip(nameTool)
    Functions.UpdatePlayerData()

    if PlayerData.Wearing.Tool ~= "None" then
        return false
    end

    if Functions.GetItemAmount(nameTool) < 4 then
        return false
    end
   
    local args = {
        [1] = "Equip",
        [2] = nameTool,
        [3] = "Tool"
    }

    repeat
        BackpackRemote:FireServer(unpack(args))
        task.wait()
        Functions.UpdatePlayerData()
    until PlayerData.Wearing.Tool == nameTool

    return true
end

function Functions.Unequip()
    Functions.UpdatePlayerData()

    if PlayerData.Wearing.Tool == "None" then
        return false
    end

    local args = {
        [1] = "Unequip",
        [2] = PlayerData.Wearing.Tool,
        [3] = "Tool"
    }

    repeat
        BackpackRemote:FireServer(unpack(args))
        task.wait()
        Functions.UpdatePlayerData()
    until PlayerData.Wearing.Tool == "None"

    return true
end

function Functions.UseTool()
    if PlayerData.Wearing.Tool == "None" then
        return false
    end

    ToolActionRemote:FireServer()

    return true
end

function Functions.IsCraftable(objectName)
    for _, v in ipairs(game:GetService("ReplicatedStorage").Craftable:GetChildren()) do
        if v.Name == objectName then
            return true
        end
    end

    return false
end

function Functions.Craft(objectName)
    if not Functions.IsCraftable(objectName) then
        return false
    end

    local CraftTrove = Trove.new()

    Functions.UpdatePlayerMaterials()

    local ObjectTemplate = game:GetService("ReplicatedStorage").Craftable:FindFirstChild(objectName)
    local ObjectMaterials = {}

    for _, materialObj in ipairs(ObjectTemplate:GetChildren()) do
        ObjectMaterials[materialObj.Name] = materialObj.Value
    end

    local hasAllMaterials = TableUtil.Every(ObjectMaterials, function(material, amount)
        return Functions.GetPlayerMaterials()["Owned"][material] >= amount
    end)

    if not hasAllMaterials then
        --No tienen todos los materiales
        return false
    end

    local args = {
        [1] = materialName
    }

    local newCraft = nil

    CraftTrove:Connect(game:GetService("Workspace").Interact.ChildAdded, function(child) 
        local owner = child:GetAttribute("Owner")

        if owner and owner == LocalPlayer.UserId then
            newCraft = child
            CraftTrove:Clean()
        end
    end)

    CraftRemote:FireServer(unpack(args))

    repeat
        task.wait()
    until newCraft ~= nil

    return newCraft
end

function getRoot(char)
	local rootPart = char:FindFirstChild('HumanoidRootPart') or char:FindFirstChild('Torso') or char:FindFirstChild('UpperTorso')
	return rootPart
end

function Functions.Teleport(newCFrame)
    local character = LocalPlayer.Character
    local humanoid = character:FindFirstChildWhichIsA("Humanoid")
    if humanoid then
        if humanoid.SeatPart then
            humanoid.Sit = false
            task.wait(0.1)
        end
    else
        return
    end
    
    local hipHeight = humanoid and humanoid.HipHeight > 0 and (humanoid.HipHeight + 1)
    local rootPart = getRoot(character)

    if not rootPart then
        return
    end
    
    rootPart.CFrame = newCFrame
end

return Functions