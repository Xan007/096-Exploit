local LocalPlayer = game:GetService("Players").LocalPlayer
local HttpService = game:GetService("HttpService")

local GetDataRemote = game:GetService("ReplicatedStorage").Remotes.GetData
local BackpackRemote = game:GetService("ReplicatedStorage").Remotes.Backpack
local ObjectInteractRemote = game:GetService("ReplicatedStorage").Remotes.ObjectInteract

local PickupRemote = game:GetService("ReplicatedStorage").Remotes.Pickup
local DropRemote = game:GetService("ReplicatedStorage").Remotes.Drop

local Data = nil

local Functions = {}

function Functions.UpdateData()
    local InvokeReturn = game:GetService("ReplicatedStorage").Remotes.GetData:InvokeServer()

    if (InvokeReturn) then
        Data = InvokeReturn
    end

    return InvokeReturn
end

function Functions.GetBackpackItems(backpack)
    backpack = backpack or Data.Backpack
    items = {}

    for _, itemTable in ipairs(backpack) do
        if (itemTable[1] ~= "None") then
            table.insert(items, itemTable)
        end
    end

    return items
end

function Functions.GetItemAmount(name)
    local amount = 0

    for i, itemTable in ipairs(Functions.GetBackpackItems()) do
        if (itemTable[1] == name) then
            amount = amount + itemTable[2]
        end
    end

    return amount
end

function Functions.DropItem(name)
    local SavedAmount = Functions.GetItemAmount(name)

    if (SavedAmount == 0) then
        return false
    end

    local args = {
        [1] = "Drop",
        [2] = name
    }  

    repeat
        BackpackRemote:FireServer(unpack(args))
        Functions.UpdateData()
    until SavedAmount > Functions.GetItemAmount(name)

    return true
end

function Functions.SaveItem(pathToItem)
    if (pathToItem == nil or pathToItem.Parent == nil) then
        return false
    end

    local ItemCFrame = pathToItem.PrimaryPart.CFrame

    local TotalPoints = 0
    local ItemPoints = 0

    if (pathToItem:GetAttribute("Type") == "Food") then
        ItemPoints = 1
    elseif (pathToItem:GetAttribute("Type") == "Tool") then
        ItemPoints = 4
    else
        return false
    end
    
    local SavedItems = Functions.GetBackpackItems()

    for _, itemTable in ipairs(SavedItems) do
        if (itemTable[2]) then
            TotalPoints = TotalPoints + itemTable[2]
        end
    end
    
    if ((TotalPoints + ItemPoints) > 30) then
        return false
    end

    if (#SavedItems >= 6) then
        local Flag = false

        for _, itemTable in ipairs(SavedItems) do
            if (itemTable[1] == pathToItem.Name and ItemPoints == 1) then
                Flag = true
            end
        end

        if (not Flag) then
            return false
        end
    end

    local args = {
        [1] = pathToItem
    }

    repeat
        LocalPlayer.Character.HumanoidRootPart.CFrame = ItemCFrame
        ObjectInteractRemote:FireServer(unpack(args))
        
        Functions.UpdateData()
    until #Functions.GetBackpackItems() > #SavedItems or pathToItem == nil or pathToItem.Parent == nil

    return true
end


function Functions.Pickup(pathToObject)
    if (pathToObject:GetAttribute("Owner") ~= nil and pathToObject:GetAttribute("Owner") ~= LocalPlayer.UserId) then
        return false
    end

    local args = {
        [1] = pathToObject
    }
    
    repeat
        LocalPlayer.Character.HumanoidRootPart.CFrame = pathToObject.PrimaryPart.CFrame
        PickupRemote:FireServer(unpack(args))
        wait()
    until pathToObject:GetAttribute("PickedUp") == true
end

function Functions.PlaceDrop(position, orientation, sticky)
    local args = {
        [1] = position,
        [2] = orientation,
        [3] = sticky
    }
    
    return DropRemote:InvokeServer(unpack(args))
end

return Functions